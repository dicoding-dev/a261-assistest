<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"
            integrity="sha512-894YE6QWD5I59HgZOGReFYm4dnWc1Qt5NtvYSaNcOP+u1T9qYdvdihz0PPSiiqn/+/3e7Jo4EaG7TubfWGUrMQ=="
            crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.10.24/css/jquery.dataTables.css">
    <link rel="stylesheet" type="text/css" href="style.css">


    <script type="text/javascript" charset="utf8" src="https://cdn.datatables.net/1.10.24/js/jquery.dataTables.js">

    </script>

</head>
<div id="container">
    <table border="1">
        <thead>
        <tr>
            <th>Number</th>
            <th>Id</th>
            <th class="w-200">Name</th>
            <th>Succes</th>
            <th>Rating</th>
            <th>Failure</th>
            <th>Url</th>
            <th>Url Review</th>
            <th>Action</th>
            <th>Delete</th>
        </tr>
        </thead>
        <tbody>

        </tbody>
    </table>

</div>

<body>

</body>
<script>
    fetch('./report.json')
        .then(response => {
            return response.json();
        })
        .then(datas => {
            const tbody = document.querySelector('tbody');

            let row = '';
            datas.forEach((data, i) => {
                let color = 'white';
                if (data.is_success === true) {
                    if (data.rating > 4) {
                        color = 'green';
                    } else {
                        color = 'yellow';
                    }

                }

                let failure = data.failure;
                if (Array.isArray(failure)) {
                    if (data.rating === 0) {
                        const index = failure.findIndex(e => {

                            if (e !== null) {
                                return e.includes(['[Optional]']) || e.includes(['Add Reading and ']) || e.includes([
                                    'Add Unreading Books '
                                ])
                            }

                        })
                        if (index > -1) {
                            failure.splice(index, failure.length - 1)
                        }

                    }

                    failure = `${failure.join('<br>')}`;
                }


                row += `
            <tr style="background:${color}">
            <td>${i}</td>
            <td>${data.id}</td>
            <td class="w-200">${data.name}</td>
            <td>${data.is_success}</td>
            <td>${data.rating}</td>
            <td class="w-max">${failure}</td>
            <td><a href="${data.url}" target="_blank" rel="noopener noreferrer">Lihat</td>
            <td><a href="${data.url}/review?stars=${data.rating}" target="_blank" rel="noopener noreferrer">Review</td>
            <td><button href="#" id="button-open-code" value="${i}">Open</button></td>
            <td><button href="#" id="button-delete" value="${data.id}">Delete</button></td>
            </tr>`;

            });
            tbody.innerHTML = row;

            $(document).ready(function () {
                $('table').DataTable({
                    "iDisplayLength": 100,
                    "order": [
                        [5, "desc"]
                    ]
                });
            });

            const url = 'http://localhost:5555/opencode'
            document.querySelectorAll('#button-open-code').forEach(button => {

                button.addEventListener('click', () => {
                    fetch(url, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(datas[button.value])
                    });

                })
            })


            const urlDelete = 'http://localhost:5555/delete/'
            document.querySelectorAll('#button-delete').forEach(button => {

                button.addEventListener('click', () => {
                    fetch(`${urlDelete}${button.value}`, {
                        method: 'DELETE',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                    });

                })
            })
        });
</script>

<script type="module">


    import * as htmlToImage from 'https://cdn.skypack.dev/html-to-image';

    Array.from(document.querySelectorAll("td pre:last-child")).forEach(error => {
        if (error.innerHTML.includes('[{"name":"[Optional]')) return

        const simplyReason = error.innerHTML.substring(error.innerHTML.indexOf('✖'))

        const pre = document.createElement("pre")
        pre.className = "error-image"
        pre.innerHTML = `<b>${simplyReason}</b>`

        error.appendChild(pre)
    })


    // const simplyReason = reason.substring(reason.indexOf('✖'))
    // message += `<pre>${eslintCheckResult.reason}</pre> <pre class="error-image"><b>${simplyReason}</b></pre>`

    addEventListener('DOMContentLoaded', (event) => {
        const dom = document.querySelectorAll('.error-image')

        dom.forEach(e => {
            htmlToImage.toPng(e)
                .then(function (dataUrl) {
                    var img = new Image();
                    img.src = dataUrl;
                    e.parentElement.appendChild(img);
                });
        })
    });


</script>

</html>